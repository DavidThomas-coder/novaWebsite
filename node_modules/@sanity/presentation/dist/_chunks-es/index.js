import{jsx as e,jsxs as t,Fragment as n}from"react/jsx-runtime";import{useState as i,useMemo as o,useEffect as r,createContext as s,useContext as c,useCallback as a,createElement as l,useRef as d,useLayoutEffect as u,lazy as p,Suspense as m}from"react";import{useDocumentStore as f,isRecord as h,isReference as v,defineLocaleResourceBundle as y,useTranslation as g,defineDocumentFieldAction as w,useWorkspace as b,pathToString as _,getPublishedId as P,definePlugin as j,isDocumentSchemaType as x}from"sanity";import{ComposeIcon as I,InfoOutlineIcon as T,ChevronRightIcon as S,DesktopIcon as O,WarningOutlineIcon as k,ErrorOutlineIcon as z,MasterDetailIcon as D}from"@sanity/icons";import{Card as A,Flex as E,Box as $,Text as C,Spinner as B,Stack as R,rem as U}from"@sanity/ui";import{styled as H}from"styled-components";import L from"lodash.get";import{Observable as N,switchMap as M,isObservable as Q,from as q,map as F,of as G,combineLatest as J,mergeAll as K,scan as V}from"rxjs";import{useIntentLink as W,useRouter as X,encodeJsonParams as Y,route as Z}from"sanity/router";import{uuid as ee}from"@sanity/uuid";const te=I,ne="presentation",ie="Presentation",oe="sanity/structure/comments",re="presentation",se=3e3,ce="2023-10-16",ae=1e3,le=100,de=2048;function ue(e,t,n){return{...e,[t]:n}}function pe(e={}){return t=>new N((e=>t.subscribe(e))).pipe(M((t=>{const n=(i=t,Object.keys(i)).map((e=>{const n=t[e];return Q(n)?q(n).pipe(F((t=>[e,t]))):G([e,n])}));var i;return e.wait?J(n).pipe(F((e=>e.reduce(((e,[t,n])=>ue(e,t,n)),{})))):q(n).pipe(K(),V(((e,[t,n])=>ue(e,t,n)),{}))})))}const me={locations:[]};function fe(e,t,n){if(!e||"object"!=typeof e)return G(e);const i=function(e){return v(e)?e._ref:"_id"in e?e._id:void 0}(e),o=function(e,t){const n=e?{...t,_id:e}:{...t};return"reference"===n._type&&(delete n._type,delete n._ref,delete n._weak,delete n._dataset,delete n._projectId,delete n._strengthenOnPublish),n}(i,e),r=t.filter((e=>!(e[0]in o)));if(i&&r.length){return function(e,t,n){const i=`*[_id==$id][0]{${t.join(", ")}}`,o={id:e};return n.listenQuery(i,o,{perspective:"previewDrafts"})}(i,[...new Set(r.map((e=>e[0])))],n).pipe(M((e=>e?fe(e,t,n):G(null))))}const s={};t.forEach((e=>{const[t,...n]=e;s[t]||(s[t]=[]),s[t].push(n)}));const c=Object.keys(s).reduce(((t,i)=>{const o=s[i].filter((e=>e.length>0));return 0===o.length?t[i]=h(e)?e[i]:void 0:t[i]=fe(e[i],o,n),t}),o);return G(c).pipe(pe({wait:!0}))}function he(e){const{id:t,resolvers:n,type:s}=e,c=f(),[a,l]=i(me),d=n&&("function"==typeof n?n:n[s]),[u,p]=i(d?"resolving":"empty"),m=o((()=>{if(d){if("function"==typeof d){const e=d({id:t,type:s},{documentStore:c});return Q(e)?e:G(e)}return"select"in d&&"resolve"in d?function(e,t,n){if(!t)return G(void 0);const{id:i,type:o}=e;if("function"==typeof t){const e=t({id:i,type:o},{documentStore:n});return Q(e)?e:G(e)}if("select"in t&&"resolve"in t){const{select:e}=t;return fe({_type:"reference",_ref:i},Object.values(e).map((e=>String(e).split(".")))||[],n).pipe(F((t=>Object.keys(e).reduce(((n,i)=>(n[i]=L(t,e[i]),n)),{}))),F(t.resolve))}return G(t)}({id:t,type:s},d,c):G(d)}}),[c,t,d,s]);return r((()=>{const e=null==m?void 0:m.subscribe((e=>{l(e||me),p(e?"resolved":"empty")}));return()=>null==e?void 0:e.unsubscribe()}),[m]),{state:a,status:u}}const ve="presentation",ye=y({locale:"en-US",namespace:ve,resources:()=>import("./resources.js")}),ge=s(null);function we(){const e=c(ge);if(!e)throw new Error("Presentation context is missing");return e}const be={positive:T,caution:k,critical:z};function _e(o){const{documentId:r,isResolving:s,options:d,schemaType:u,showPresentationTitle:p}=o,{locations:m,message:f,tone:h}=o.state,v=(null==m?void 0:m.length)||0,{t:y}=g(ve),w=c(ge),[b,_]=i(!1),P=a((()=>{v&&_((e=>!e))}),[v]),j=s?y("locations-banner.resolving.text"):f||y("locations-banner.locations-count",{count:v});return e(A,{padding:1,radius:2,border:!0,tone:h,children:t("div",{style:{margin:-1},children:[!m&&t(E,{align:"flex-start",gap:3,padding:3,children:[h&&e($,{flex:"none",children:e(C,{size:1,children:l(be[h])})}),e($,{flex:1,children:t(C,{size:1,weight:"medium",children:[p&&t(n,{children:[d.title||ie," · "]}),j]})})]}),m&&t(n,{children:[e(A,{as:v?"button":void 0,onClick:P,padding:3,radius:1,tone:"inherit",children:t(E,{gap:3,children:[e($,{flex:"none",children:s?e(B,{size:1}):e(C,{size:1,children:0===v?e(T,{}):e(S,{style:{transform:`rotate(${b?"90deg":0})`,transition:"transform 100ms ease-in-out"}})})}),e($,{flex:1,children:t(C,{size:1,weight:"medium",children:[p&&t(n,{children:[d.title||ie," · "]}),j]})})]})}),e(R,{hidden:!b,marginTop:1,space:1,children:m.map(((t,n)=>e(Pe,{active:(d.name||ne)===(null==w?void 0:w.name)&&t.href===(null==w?void 0:w.params.preview),documentId:r,documentType:u.name,node:t,toolName:d.name||ne},n)))})]})]})})}function Pe(n){const{documentId:i,documentType:o,node:r,active:s,toolName:d}=n,u=c(ge),p=d===function(){try{return we().name}catch{return}}(),m=null==u?void 0:u.navigate,f=W({intent:"edit",params:{id:i,type:o,mode:"presentation",presentation:d,...null==u?void 0:u.structureParams,preview:r.href}}),h=a((()=>{null==m||m({},{preview:r.href})}),[r.href,m]);return l(A,{...p?{}:f,as:"a",key:r.href,onClick:p?h:f.onClick,padding:3,radius:1,pressed:s,tone:"inherit"},t(E,{gap:3,children:[e($,{flex:"none",children:e(C,{size:1,children:e(O,{})})}),t(R,{flex:1,space:2,children:[e(C,{size:1,weight:"medium",children:r.title}),e(C,{muted:!0,size:1,textOverflow:"ellipsis",children:r.href})]})]}))}const je=s(null),xe=H(R)`
  min-height: ${U(42)};

  & + &:empty {
    display: none;
  }
`;function Ie(t){var n;const{documentId:i,options:o,schemaType:r}=t,s=c(je),{state:a,status:l}=he({id:i,resolvers:(null==(n=o.resolve)?void 0:n.locations)||o.locate,type:r.name});if(s&&s.options[0]!==o||"empty"===l)return null;const d=(null==s?void 0:s.options)||[];return e(xe,{marginBottom:5,space:5,children:e(R,{space:2,children:d.map(((t,n)=>e(_e,{documentId:i,isResolving:"resolving"===l,options:t,schemaType:r,showPresentationTitle:d.length>1,state:a},n)))})})}function Te(t){const{children:n,options:r}=t,s=c(je),l=null==s?void 0:s.register,[p,m]=i((()=>[])),f=a((e=>l?l(e):(m((t=>[e].concat(t))),()=>{m((t=>t.filter((t=>t!==e))))})),[l]),h=d(f);h.current=f;const v=o((()=>({options:(null==s?void 0:s.options)||p,register:f})),[p,s,f]);return u((()=>h.current(r)),[r]),e(je.Provider,{value:v,children:n})}const Se=w({name:"presentation/openInStructure",useAction({documentId:e,documentType:t,path:n}){const i=b(),{navigateIntent:r}=X(),s=c(ge),a=o((()=>function(e,t,n){var i;const o=e.map((e=>{var i;return{tool:e,match:null==(i=e.canHandleIntent)?void 0:i.call(e,"edit",{id:t,type:n,mode:"structure"},{})}})),r=o.filter((e=>h(e.match)&&e.match.mode));return r.length>0?r[0].tool:null==(i=o.filter((e=>e.match))[0])?void 0:i.tool}(i.tools,e,t)),[e,t,i.tools]);return{type:"action",hidden:!s||n.length>0||!a,icon:(null==a?void 0:a.icon)||D,title:`Open in ${(null==a?void 0:a.title)||"Structure"}`,onAction(){r("edit",{id:e,type:t,mode:"structure",path:_(n)})},renderAsButton:!0}}});function Oe(e,t,n,i){const{id:o,mode:r,path:s,presentation:c,type:a,...l}=t;return"edit"===e&&o?{type:a||"*",id:P(o),path:s,_searchParams:Object.entries(l)}:"create"===e?(l.preview=l.preview||new URLSearchParams(window.location.search).get("preview")||"/",i&&"object"==typeof i&&(l.templateParams=Y(i)),{type:a||"*",id:o||ee(),_searchParams:Object.entries(l)}):{intent:e,params:t,payload:i}}const ke=Z.create("/",{__unsafe_disableScopedSearchParams:!0},[Z.intents("/intent"),Z.create(":type",[Z.create(":id",[Z.create(":path")])])]),ze=p((()=>import("./PresentationTool.js"))),De=p((()=>import("./BroadcastDisplayedDocument.js")));function Ae(e){return e}function Ee(e){return e}const $e=j((n=>{var i;const o=n.name||ne;"locate"in n&&console.warn("Presentation’s `locate` option is deprecated. Use `resolve.locations` instead.");const r=!!(null!=(i=n.resolve)&&i.locations||n.locate);return{i18n:{bundles:[ye]},document:{unstable_fieldActions:e=>[...e.filter((e=>e.name!==Se.name)),Se]},form:{components:{input:function(i){const o=i.value,s=null!=o&&o._id?P(null==o?void 0:o._id):void 0;return x(i.schemaType)?t(Te,{options:n,children:[r&&s&&e(Ie,{documentId:s,options:n,schemaType:i.schemaType}),i.renderDefault(i),e(m,{children:e(De,{value:o},s)},"broadcast-displayed-document")]}):i.renderDefault(i)}}},tools:[{icon:n.icon||te,name:o,title:n.title,component:ze,options:n,canHandleIntent:(e,t)=>"create"===e?function(e){return"type"in e&&(!("presentation"in e)||e.presentation===o)&&(!("template"in e)||{template:!0})}(t):"edit"===e&&function(e){return"type"in e&&"id"in e&&(!("presentation"in e)||e.presentation===o)&&(!("mode"in e)||{mode:e.mode===re})}(t),getIntentState:Oe,router:ke}]}})),Ce=s(null);function Be(){const e=c(Ce);if(!e)throw new Error("Presentation navigate context is missing");return e}const Re=s(null);function Ue(e=!0){const t=c(Re);if(e&&!t)throw new Error("Presentation params context is missing");return t}export{ce as A,oe as C,ne as D,re as E,de as L,se as M,Ce as P,Re as a,ge as b,ae as c,Ue as d,le as e,Be as f,Ae as g,Ee as h,$e as i,ve as p,we as u};//# sourceMappingURL=index.js.map
