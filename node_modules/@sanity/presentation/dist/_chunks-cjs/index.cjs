"use strict";var e=require("react/jsx-runtime"),t=require("react"),n=require("sanity"),r=require("@sanity/icons"),o=require("@sanity/ui"),i=require("styled-components"),s=require("lodash.get"),c=require("rxjs"),a=require("sanity/router"),u=require("@sanity/uuid");function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=l(s);const p=r.ComposeIcon,m="presentation",f="Presentation",x="presentation";function h(e,t,n){return{...e,[t]:n}}function v(e={}){return t=>new c.Observable((e=>t.subscribe(e))).pipe(c.switchMap((t=>{const n=(r=t,Object.keys(r)).map((e=>{const n=t[e];return c.isObservable(n)?c.from(n).pipe(c.map((t=>[e,t]))):c.of([e,n])}));var r;return e.wait?c.combineLatest(n).pipe(c.map((e=>e.reduce(((e,[t,n])=>h(e,t,n)),{})))):c.from(n).pipe(c.mergeAll(),c.scan(((e,[t,n])=>h(e,t,n)),{}))})))}const y={locations:[]};function g(e,t,r){if(!e||"object"!=typeof e)return c.of(e);const o=function(e){return n.isReference(e)?e._ref:"_id"in e?e._id:void 0}(e),i=function(e,t){const n=e?{...t,_id:e}:{...t};return"reference"===n._type&&(delete n._type,delete n._ref,delete n._weak,delete n._dataset,delete n._projectId,delete n._strengthenOnPublish),n}(o,e),s=t.filter((e=>!(e[0]in i)));if(o&&s.length){return function(e,t,n){const r=`*[_id==$id][0]{${t.join(", ")}}`,o={id:e};return n.listenQuery(r,o,{perspective:"previewDrafts"})}(o,[...new Set(s.map((e=>e[0])))],r).pipe(c.switchMap((e=>e?g(e,t,r):c.of(null))))}const a={};t.forEach((e=>{const[t,...n]=e;a[t]||(a[t]=[]),a[t].push(n)}));const u=Object.keys(a).reduce(((t,o)=>{const i=a[o].filter((e=>e.length>0));return 0===i.length?t[o]=n.isRecord(e)?e[o]:void 0:t[o]=g(e[o],i,r),t}),i);return c.of(u).pipe(v({wait:!0}))}function j(e){const{id:r,resolvers:o,type:i}=e,s=n.useDocumentStore(),[a,u]=t.useState(y),l=o&&("function"==typeof o?o:o[i]),[p,m]=t.useState(l?"resolving":"empty"),f=t.useMemo((()=>{if(l){if("function"==typeof l){const e=l({id:r,type:i},{documentStore:s});return c.isObservable(e)?e:c.of(e)}return"select"in l&&"resolve"in l?function(e,t,n){if(!t)return c.of(void 0);const{id:r,type:o}=e;if("function"==typeof t){const e=t({id:r,type:o},{documentStore:n});return c.isObservable(e)?e:c.of(e)}if("select"in t&&"resolve"in t){const{select:e}=t;return g({_type:"reference",_ref:r},Object.values(e).map((e=>String(e).split(".")))||[],n).pipe(c.map((t=>Object.keys(e).reduce(((n,r)=>(n[r]=d.default(t,e[r]),n)),{}))),c.map(t.resolve))}return c.of(t)}({id:r,type:i},l,s):c.of(l)}}),[s,r,l,i]);return t.useEffect((()=>{const e=null==f?void 0:f.subscribe((e=>{u(e||y),m(e?"resolved":"empty")}));return()=>null==e?void 0:e.unsubscribe()}),[f]),{state:a,status:p}}const b="presentation",w=n.defineLocaleResourceBundle({locale:"en-US",namespace:b,resources:()=>Promise.resolve().then((function(){return require("./resources.cjs")}))}),I=t.createContext(null);function C(){const e=t.useContext(I);if(!e)throw new Error("Presentation context is missing");return e}const P={positive:r.InfoOutlineIcon,caution:r.WarningOutlineIcon,critical:r.ErrorOutlineIcon};function S(i){const{documentId:s,isResolving:c,options:a,schemaType:u,showPresentationTitle:l}=i,{locations:d,message:p,tone:x}=i.state,h=(null==d?void 0:d.length)||0,{t:v}=n.useTranslation(b),y=t.useContext(I),[g,j]=t.useState(!1),w=t.useCallback((()=>{h&&j((e=>!e))}),[h]),C=c?v("locations-banner.resolving.text"):p||v("locations-banner.locations-count",{count:h});return e.jsx(o.Card,{padding:1,radius:2,border:!0,tone:x,children:e.jsxs("div",{style:{margin:-1},children:[!d&&e.jsxs(o.Flex,{align:"flex-start",gap:3,padding:3,children:[x&&e.jsx(o.Box,{flex:"none",children:e.jsx(o.Text,{size:1,children:t.createElement(P[x])})}),e.jsx(o.Box,{flex:1,children:e.jsxs(o.Text,{size:1,weight:"medium",children:[l&&e.jsxs(e.Fragment,{children:[a.title||f," · "]}),C]})})]}),d&&e.jsxs(e.Fragment,{children:[e.jsx(o.Card,{as:h?"button":void 0,onClick:w,padding:3,radius:1,tone:"inherit",children:e.jsxs(o.Flex,{gap:3,children:[e.jsx(o.Box,{flex:"none",children:c?e.jsx(o.Spinner,{size:1}):e.jsx(o.Text,{size:1,children:0===h?e.jsx(r.InfoOutlineIcon,{}):e.jsx(r.ChevronRightIcon,{style:{transform:`rotate(${g?"90deg":0})`,transition:"transform 100ms ease-in-out"}})})}),e.jsx(o.Box,{flex:1,children:e.jsxs(o.Text,{size:1,weight:"medium",children:[l&&e.jsxs(e.Fragment,{children:[a.title||f," · "]}),C]})})]})}),e.jsx(o.Stack,{hidden:!g,marginTop:1,space:1,children:d.map(((t,n)=>e.jsx(T,{active:(a.name||m)===(null==y?void 0:y.name)&&t.href===(null==y?void 0:y.params.preview),documentId:s,documentType:u.name,node:t,toolName:a.name||m},n)))})]})]})})}function T(n){const{documentId:i,documentType:s,node:c,active:u,toolName:l}=n,d=t.useContext(I),p=l===function(){try{return C().name}catch{return}}(),m=null==d?void 0:d.navigate,f=a.useIntentLink({intent:"edit",params:{id:i,type:s,mode:"presentation",presentation:l,...null==d?void 0:d.structureParams,preview:c.href}}),x=t.useCallback((()=>{null==m||m({},{preview:c.href})}),[c.href,m]);return t.createElement(o.Card,{...p?{}:f,as:"a",key:c.href,onClick:p?x:f.onClick,padding:3,radius:1,pressed:u,tone:"inherit"},e.jsxs(o.Flex,{gap:3,children:[e.jsx(o.Box,{flex:"none",children:e.jsx(o.Text,{size:1,children:e.jsx(r.DesktopIcon,{})})}),e.jsxs(o.Stack,{flex:1,space:2,children:[e.jsx(o.Text,{size:1,weight:"medium",children:c.title}),e.jsx(o.Text,{muted:!0,size:1,textOverflow:"ellipsis",children:c.href})]})]}))}const _=t.createContext(null),k=i.styled(o.Stack)`
  min-height: ${o.rem(42)};

  & + &:empty {
    display: none;
  }
`;function O(n){var r;const{documentId:i,options:s,schemaType:c}=n,a=t.useContext(_),{state:u,status:l}=j({id:i,resolvers:(null==(r=s.resolve)?void 0:r.locations)||s.locate,type:c.name});if(a&&a.options[0]!==s||"empty"===l)return null;const d=(null==a?void 0:a.options)||[];return e.jsx(k,{marginBottom:5,space:5,children:e.jsx(o.Stack,{space:2,children:d.map(((t,n)=>e.jsx(S,{documentId:i,isResolving:"resolving"===l,options:t,schemaType:c,showPresentationTitle:d.length>1,state:u},n)))})})}function q(n){const{children:r,options:o}=n,i=t.useContext(_),s=null==i?void 0:i.register,[c,a]=t.useState((()=>[])),u=t.useCallback((e=>s?s(e):(a((t=>[e].concat(t))),()=>{a((t=>t.filter((t=>t!==e))))})),[s]),l=t.useRef(u);l.current=u;const d=t.useMemo((()=>({options:(null==i?void 0:i.options)||c,register:u})),[c,i,u]);return t.useLayoutEffect((()=>l.current(o)),[o]),e.jsx(_.Provider,{value:d,children:r})}const D=n.defineDocumentFieldAction({name:"presentation/openInStructure",useAction({documentId:e,documentType:o,path:i}){const s=n.useWorkspace(),{navigateIntent:c}=a.useRouter(),u=t.useContext(I),l=t.useMemo((()=>function(e,t,r){var o;const i=e.map((e=>{var n;return{tool:e,match:null==(n=e.canHandleIntent)?void 0:n.call(e,"edit",{id:t,type:r,mode:"structure"},{})}})),s=i.filter((e=>n.isRecord(e.match)&&e.match.mode));return s.length>0?s[0].tool:null==(o=i.filter((e=>e.match))[0])?void 0:o.tool}(s.tools,e,o)),[e,o,s.tools]);return{type:"action",hidden:!u||i.length>0||!l,icon:(null==l?void 0:l.icon)||r.MasterDetailIcon,title:`Open in ${(null==l?void 0:l.title)||"Structure"}`,onAction(){c("edit",{id:e,type:o,mode:"structure",path:n.pathToString(i)})},renderAsButton:!0}}});function z(e,t,r,o){const{id:i,mode:s,path:c,presentation:l,type:d,...p}=t;return"edit"===e&&i?{type:d||"*",id:n.getPublishedId(i),path:c,_searchParams:Object.entries(p)}:"create"===e?(p.preview=p.preview||new URLSearchParams(window.location.search).get("preview")||"/",o&&"object"==typeof o&&(p.templateParams=a.encodeJsonParams(o)),{type:d||"*",id:i||u.uuid(),_searchParams:Object.entries(p)}):{intent:e,params:t,payload:o}}const E=a.route.create("/",{__unsafe_disableScopedSearchParams:!0},[a.route.intents("/intent"),a.route.create(":type",[a.route.create(":id",[a.route.create(":path")])])]),R=t.lazy((()=>Promise.resolve().then((function(){return require("./PresentationTool.cjs")})))),B=t.lazy((()=>Promise.resolve().then((function(){return require("./BroadcastDisplayedDocument.cjs")}))));const A=n.definePlugin((r=>{var o;const i=r.name||m;"locate"in r&&console.warn("Presentation’s `locate` option is deprecated. Use `resolve.locations` instead.");const s=!!(null!=(o=r.resolve)&&o.locations||r.locate);return{i18n:{bundles:[w]},document:{unstable_fieldActions:e=>[...e.filter((e=>e.name!==D.name)),D]},form:{components:{input:function(o){const i=o.value,c=null!=i&&i._id?n.getPublishedId(null==i?void 0:i._id):void 0;return n.isDocumentSchemaType(o.schemaType)?e.jsxs(q,{options:r,children:[s&&c&&e.jsx(O,{documentId:c,options:r,schemaType:o.schemaType}),o.renderDefault(o),e.jsx(t.Suspense,{children:e.jsx(B,{value:i},c)},"broadcast-displayed-document")]}):o.renderDefault(o)}}},tools:[{icon:r.icon||p,name:i,title:r.title,component:R,options:r,canHandleIntent:(e,t)=>"create"===e?function(e){return"type"in e&&(!("presentation"in e)||e.presentation===i)&&(!("template"in e)||{template:!0})}(t):"edit"===e&&function(e){return"type"in e&&"id"in e&&(!("presentation"in e)||e.presentation===i)&&(!("mode"in e)||{mode:e.mode===x})}(t),getIntentState:z,router:E}]}})),F=t.createContext(null);const M=t.createContext(null);exports.A="2023-10-16",exports.C="sanity/structure/comments",exports.D=m,exports.E=x,exports.L=2048,exports.M=3e3,exports.P=F,exports.a=M,exports.b=I,exports.c=1e3,exports.d=function(e=!0){const n=t.useContext(M);if(e&&!n)throw new Error("Presentation params context is missing");return n},exports.e=100,exports.f=function(){const e=t.useContext(F);if(!e)throw new Error("Presentation navigate context is missing");return e},exports.g=function(e){return e},exports.h=function(e){return e},exports.i=A,exports.p=b,exports.u=C;//# sourceMappingURL=index.cjs.map
